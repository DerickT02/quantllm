<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuantLLM - OHLCV Market Data</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .content {
        padding: 30px;
      }

      .search-section {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
      }

      .search-form {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
      }

      .form-group {
        flex: 1;
        min-width: 200px;
      }

      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        padding: 12px 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      }

      .popular-symbols {
        margin-top: 20px;
      }

      .symbol-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }

      .symbol-btn {
        padding: 8px 12px;
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        font-weight: 600;
      }

      .symbol-btn:hover {
        border-color: #667eea;
        background: #f8f9ff;
      }

      .results-section {
        display: none;
      }

      .market-summary {
        background: #e3f2fd;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        border-left: 5px solid #2196f3;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 15px;
      }

      .summary-item {
        text-align: center;
      }

      .summary-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1976d2;
        margin-bottom: 5px;
      }

      .summary-label {
        color: #666;
        font-size: 0.9rem;
      }

      .data-table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table th {
        background: #f8f9fa;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #e9ecef;
      }

      .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e9ecef;
      }

      .data-table tr:hover {
        background: #f8f9ff;
      }

      .positive {
        color: #28a745;
      }

      .negative {
        color: #dc3545;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        border-left: 5px solid #dc3545;
      }

      .nav-links {
        margin-top: 30px;
        text-align: center;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
      }

      @media (max-width: 768px) {
        .search-form {
          flex-direction: column;
        }

        .header h1 {
          font-size: 2rem;
        }

        .summary-grid {
          grid-template-columns: 1fr 1fr;
        }
      }

      .analyze-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      }

      .download-btn {
        background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
      }

      /* N8N Integration Styles */
      .n8n-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 15px;
        width: 80%;
        max-width: 600px;
        position: relative;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      }

      .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 15px;
        top: 10px;
      }

      .close-btn:hover {
        color: #667eea;
      }

      .n8n-result {
        padding: 20px 0;
      }

      .result-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 20px 0;
      }

      .result-item {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .analysis-summary {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .success-msg {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #28a745;
        margin-top: 15px;
      }

      .error-msg {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        border-left: 5px solid #dc3545;
        margin-top: 15px;
      }

      .n8n-status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }

      .n8n-enabled {
        background: #d4edda;
        color: #155724;
      }

      .n8n-disabled {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container">
        <div class="header">
          <h1>
            üìä QuantLLM
            <span style="font-size: 1.5rem">OHLCV Market Data</span>
          </h1>
          <p>Real-time market data powered by Alpha Vantage API</p>
          <div id="n8n-status" class="n8n-status n8n-disabled">
            ‚ö†Ô∏è N8N Not Configured
          </div>
        </div>

        <div class="content">
          <div id="n8n-config" class="n8n-config" style="display: none;">
            <h3>üîß N8N Webhook Configuration</h3>
            <p>Enter your n8n webhook URL to enable workflow integration:</p>
            <input
              type="url"
              id="webhook-url"
              class="config-input"
              placeholder="https://your-n8n-instance.com/webhook/quantllm-analysis"
            />
            <button class="config-btn" onclick="updateWebhookUrl()">
              üíæ Save Webhook
            </button>
            <button class="config-btn" onclick="testN8NConnection()">
              üß™ Test Connection
            </button>
            <button
              class="config-btn"
              onclick="document.getElementById('n8n-config').style.display='none'"
            >
              ‚ùå Close
            </button>
          </div>

          <div class="search-section">
          <h2>üîç Search Market Data</h2>
          <form class="search-form" id="searchForm">
            <div class="form-group">
              <label for="symbol">Symbol</label>
              <input
                type="text"
                id="symbol"
                placeholder="e.g., AAPL, BTC, GOOGL"
                required
              />
            </div>
            <div class="form-group">
              <label for="interval">Interval</label>
              <select id="interval">
                <option value="daily">Daily</option>
                <option value="60min">1 Hour</option>
                <option value="30min">30 Min</option>
                <option value="15min">15 Min</option>
                <option value="5min">5 Min</option>
                <option value="1min">1 Min</option>
              </select>
            </div>
            <div class="form-group">
              <label for="periods">Periods</label>
              <input
                type="number"
                id="periods"
                value="100"
                min="1"
                max="5000"
              />
            </div>
            <button type="submit" class="btn">üìä Get Data</button>
            <button type="button" class="btn analyze-btn" id="analyzeBtn">
              ü§ñ Analyze
            </button>
            <button
              type="button"
              class="btn download-btn"
              id="downloadBtn"
              style="display: none"
            >
              üì• CSV
            </button>
          </form>

          <div class="popular-symbols">
            <h3>Popular Symbols</h3>
            <div class="symbol-grid">
              <div class="symbol-btn" data-category="stocks">üìà Stocks</div>
              <div class="symbol-btn" data-category="crypto">ü™ô Crypto</div>
              <div class="symbol-btn" data-category="forex">üí± Forex</div>
            </div>
            <div
              id="categorySymbols"
              class="symbol-grid"
              style="margin-top: 10px"
            ></div>
          </div>
        </div>

        <div id="results" class="results-section">
          <div id="marketSummary" class="market-summary"></div>
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Open</th>
                  <th>High</th>
                  <th>Low</th>
                  <th>Close</th>
                  <th>Volume</th>
                  <th>Change</th>
                </tr>
              </thead>
              <tbody id="dataTable"></tbody>
            </table>
          </div>
        </div>

        <div id="loading" class="loading" style="display: none">
          <h3>‚è≥ Loading market data...</h3>
          <p>Please wait while we fetch the latest information</p>
        </div>

        <div id="error" class="error" style="display: none"></div>

        <div class="nav-links">
          <a href="/" class="btn btn-secondary">üè† Back to Dashboard</a>
          <a href="/chat" class="btn">üí¨ AI Chat</a>
        </div>
      </div>
    </div>

    <script>
      let currentData = null;

      document
        .getElementById("searchForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await fetchMarketData();
        });

        document
          .getElementById("analyzeBtn")
          .addEventListener("click", async () => {
            const symbol = document.getElementById("symbol").value.trim();
            const interval = document.getElementById("interval").value;
            const periods = document.getElementById("periods").value;

            if (!symbol) {
              alert("Please enter a symbol first");
              return;
            }

            // Show loading state
            const btn = document.getElementById("analyzeBtn");
            const originalText = btn.innerHTML;
            btn.innerHTML = "üîÑ Analyzing & Sending to n8n...";
            btn.disabled = true;

            try {
              // Send analysis to n8n workflow
              const response = await fetch("/api/n8n/analyze", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  symbol: symbol,
                  interval: interval,
                  periods: parseInt(periods),
                  trigger: "analyze_button",
                }),
              });

              const result = await response.json();

              if (result.success) {
                // Show success message
                showN8NResult(result);
              } else {
                throw new Error(result.error || "Failed to send to n8n");
              }
            } catch (error) {
              console.error("N8N Analysis Error:", error);
              alert(`Error sending to n8n: ${error.message}`);
            } finally {
              // Reset button
              btn.innerHTML = originalText;
              btn.disabled = false;
            }
          });      document.getElementById("downloadBtn").addEventListener("click", () => {
        if (!currentData) return;

        const symbol = document.getElementById("symbol").value.trim();
        const interval = document.getElementById("interval").value;
        const periods = document.getElementById("periods").value;

        window.open(
          `/api/market/ohlcv/${symbol}?interval=${interval}&periods=${periods}&format=csv`
        );
      });

      async function fetchMarketData() {
        const symbol = document.getElementById("symbol").value.trim();
        const interval = document.getElementById("interval").value;
        const periods = document.getElementById("periods").value;

        if (!symbol) {
          showError("Please enter a symbol");
          return;
        }

        showLoading(true);
        hideError();

        try {
          const response = await fetch(
            `/api/market/data/${symbol}?interval=${interval}&periods=${periods}`
          );
          const data = await response.json();

          if (!response.ok) {
            throw new Error(
              data.details || data.error || "Failed to fetch data"
            );
          }

          currentData = data;
          displayResults(data);
          document.getElementById("downloadBtn").style.display = "inline-flex";
        } catch (error) {
          showError(`Error: ${error.message}`);
          console.error("Fetch error:", error);
        } finally {
          showLoading(false);
        }
      }

      function displayResults(data) {
        // Market summary
        const summary = data.marketSummary;
        const summaryHtml = `
                <h2>üìä ${summary.symbol} Market Summary</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value">$${summary.currentPrice?.toFixed(
                          4
                        )}</div>
                        <div class="summary-label">Current Price</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value ${
                          summary.changePercent >= 0 ? "positive" : "negative"
                        }">
                            ${
                              summary.changePercent >= 0 ? "+" : ""
                            }${summary.changePercent?.toFixed(2)}%
                        </div>
                        <div class="summary-label">Change</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${summary.volume?.toLocaleString()}</div>
                        <div class="summary-label">Volume</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">$${summary.high52w?.toFixed(
                          2
                        )}</div>
                        <div class="summary-label">52W High</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">$${summary.low52w?.toFixed(
                          2
                        )}</div>
                        <div class="summary-label">52W Low</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">${data.dataPoints}</div>
                        <div class="summary-label">Data Points</div>
                    </div>
                </div>
            `;
        document.getElementById("marketSummary").innerHTML = summaryHtml;

        // Data table
        const tableBody = document.getElementById("dataTable");
        tableBody.innerHTML = data.data
          .slice(-20)
          .reverse()
          .map(
            (row) => `
                <tr>
                    <td>${row.date}</td>
                    <td>$${row.open}</td>
                    <td>$${row.high}</td>
                    <td>$${row.low}</td>
                    <td>$${row.close}</td>
                    <td>${row.volume}</td>
                    <td class="${
                      row.change.includes("+") ? "positive" : "negative"
                    }">${row.change}</td>
                </tr>
            `
          )
          .join("");

        document.getElementById("results").style.display = "block";
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
        if (show) {
          document.getElementById("results").style.display = "none";
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById("error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        document.getElementById("results").style.display = "none";
      }

      function hideError() {
        document.getElementById("error").style.display = "none";
      }

      // Popular symbols functionality
      document.querySelectorAll(".symbol-btn[data-category]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const category = btn.dataset.category;
          try {
            const response = await fetch(`/api/market/popular/${category}`);
            const data = await response.json();

            const symbolsContainer = document.getElementById("categorySymbols");
            symbolsContainer.innerHTML = data.symbols
              .map(
                (symbol) =>
                  `<div class="symbol-btn" onclick="selectSymbol('${symbol}')">${symbol}</div>`
              )
              .join("");
          } catch (error) {
            console.error("Error fetching popular symbols:", error);
          }
        });
      });

        function selectSymbol(symbol) {
          document.getElementById("symbol").value = symbol;
        }

        // N8N Integration Functions
        function showN8NResult(result) {
          const analysis = result.analysis;
          const n8nResult = result.n8n;
          
          // Create result modal or section
          const resultHtml = `
            <div class="n8n-result">
              <h3>‚úÖ Analysis Complete & Sent to n8n!</h3>
              <div class="result-grid">
                <div class="result-item">
                  <strong>Symbol:</strong> ${analysis.symbol}
                </div>
                <div class="result-item">
                  <strong>Analysis Status:</strong> ‚úÖ Complete
                </div>
                <div class="result-item">
                  <strong>N8N Status:</strong> ${n8nResult.success ? '‚úÖ Sent' : '‚ùå Failed'}
                </div>
                <div class="result-item">
                  <strong>Workflow ID:</strong> ${n8nResult.workflowId || 'N/A'}
                </div>
                <div class="result-item">
                  <strong>Data Points:</strong> ${analysis.dataPoints}
                </div>
                <div class="result-item">
                  <strong>Current Price:</strong> $${analysis.marketSummary.currentPrice}
                </div>
              </div>
              <div class="analysis-summary">
                <h4>üìä Analysis Summary:</h4>
                <p><strong>Sentiment:</strong> ${analysis.analysis.summary.overallSentiment}</p>
                <p><strong>RSI:</strong> ${analysis.analysis.indicator.rsi?.toFixed(2)} (${analysis.analysis.indicator.regime})</p>
                <p><strong>Pattern:</strong> ${analysis.analysis.pattern.pattern}</p>
                <p><strong>Trend:</strong> ${analysis.analysis.trend.trend}</p>
              </div>
              ${n8nResult.success ? 
                '<p class="success-msg">üéâ Your analysis has been successfully sent to your n8n workflow!</p>' : 
                `<p class="error-msg">‚ö†Ô∏è N8N Error: ${n8nResult.message}</p>`
              }
            </div>
          `;
          
          // Show in a modal or replace results section
          showN8NModal(resultHtml);
        }

        function showN8NModal(content) {
          // Create modal if it doesn't exist
          let modal = document.getElementById('n8n-modal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'n8n-modal';
            modal.className = 'n8n-modal';
            modal.innerHTML = `
              <div class="modal-content">
                <span class="close-btn" onclick="closeN8NModal()">&times;</span>
                <div id="modal-body"></div>
              </div>
            `;
            document.body.appendChild(modal);
          }
          
          document.getElementById('modal-body').innerHTML = content;
          modal.style.display = 'block';
        }

        function closeN8NModal() {
          const modal = document.getElementById('n8n-modal');
          if (modal) {
            modal.style.display = 'none';
          }
        }

        // N8N Configuration Functions
        async function checkN8NStatus() {
          try {
            const response = await fetch('/api/n8n/status');
            const status = await response.json();
            updateN8NStatusDisplay(status);
            return status;
          } catch (error) {
            console.error('Failed to check n8n status:', error);
            return { enabled: false, error: error.message };
          }
        }

        function updateN8NStatusDisplay(status) {
          const statusEl = document.getElementById('n8n-status');
          if (statusEl) {
            statusEl.innerHTML = status.enabled ? 
              '‚úÖ N8N Connected' : 
              '‚ö†Ô∏è N8N Not Configured';
            statusEl.className = status.enabled ? 'n8n-status n8n-enabled' : 'n8n-status n8n-disabled';
            
            // Make status clickable to open config
            statusEl.onclick = () => {
              const config = document.getElementById('n8n-config');
              config.style.display = config.style.display === 'none' ? 'block' : 'none';
            };
            statusEl.style.cursor = 'pointer';
            statusEl.title = 'Click to configure N8N webhook';
          }
        }

        async function updateWebhookUrl() {
          const url = document.getElementById('webhook-url').value.trim();
          
          if (!url) {
            alert('Please enter a webhook URL');
            return;
          }

          try {
            const response = await fetch('/api/n8n/webhook', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ url: url }),
            });

            const result = await response.json();

            if (result.success) {
              alert('‚úÖ Webhook URL updated successfully!');
              checkN8NStatus(); // Refresh status
              document.getElementById('n8n-config').style.display = 'none';
            } else {
              alert(`‚ùå Failed to update webhook: ${result.message}`);
            }
          } catch (error) {
            alert(`‚ùå Error updating webhook: ${error.message}`);
          }
        }

        async function testN8NConnection() {
          try {
            const response = await fetch('/api/n8n/test', { method: 'POST' });
            const result = await response.json();
            
            alert(result.success ? 
              '‚úÖ N8N connection test successful!' : 
              `‚ùå N8N connection test failed: ${result.message}`
            );
            
            return result;
          } catch (error) {
            alert(`‚ùå N8N test error: ${error.message}`);
            return { success: false, message: error.message };
          }
        }              // Load default popular stocks on page load
        document.addEventListener("DOMContentLoaded", () => {
          document
            .querySelector('.symbol-btn[data-category="stocks"]')
            .click();
          
          // Check n8n status
          checkN8NStatus();
        });
    </script>
  </body>
</html>
